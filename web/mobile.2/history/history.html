<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>询价历史</title>
	<!-- <link rel="stylesheet" href="https://cdn.bootcss.com/weui/1.1.2/style/weui.min.css"> -->
	<!-- <link rel="stylesheet" href="https://cdn.bootcss.com/jquery-weui/1.2.0/css/jquery-weui.min.css"> -->
	<link rel="stylesheet" href="../../js/weui/weui.min.css">
	<link rel="stylesheet" href="../../js/weui/jquery-weui.min.css">
	<link rel="stylesheet" href="history.css">
</head>
<body>
	<div class="paging">
		<div id="header">
			<h3>询价历史</h3>
		</div>
	</div>
	<div class="weui-search-bar" id="searchBar">
		<form class="weui-search-bar__form">
			<div class="weui-search-bar__box">
				<i class="weui-icon-search"></i>
				<input type="search" class="weui-search-bar__input" id="searchInput" placeholder="搜索历史">
				<a href="javascript:" class="weui-icon-clear" id="searchClear"></a>
			</div>
			<label class="weui-search-bar__label" id="searchText">
				<i class="weui-icon-search"></i>
				<span>搜索历史</span>
			</label>
		</form>
		<a href="javascript:" class="weui-search-bar__cancel-btn" id="searchCancel">取消</a>
	</div>
	<div class="container">
		<div class="weui-loadmore weui-loadmore_line noMoreDataTip">
			<span class="weui-loadmore__tips">暂无数据</span>
		</div>
		<div class="resultPart clone">
			<!-- <div class="delete">x</div> -->
			<div class="weui-form-preview">
				<div class="weui-form-preview__hd">
					<label class="weui-form-preview__label">总金额</label>
					<em class="weui-form-preview__value">¥<sapn class="totalPrice">0</sapn></em>
				</div>
				<div class="weui-form-preview__bd">
					<div class="weui-form-preview__item">
						<label class="weui-form-preview__label">查询历史</label>
						<span class="weui-form-preview__value"><sapn class="searchedValue"></sapn></span>
					</div>
					<div class="weui-form-preview__item">
						<label class="weui-form-preview__label">客户</label>
						<span class="weui-form-preview__value"><sapn class="merchantName"></sapn></span>
					</div>
					<div class="weui-form-preview__item">
						<label class="weui-form-preview__label">品种</label>
						<span class="weui-form-preview__value"><sapn class="count"></sapn></span>
					</div>
					<div class="weui-form-preview__item">
						<label class="weui-form-preview__label">时间</label>
						<span class="weui-form-preview__value"><sapn class="time"></sapn></span>
					</div>
					<div class="weui-form-preview__item">
						<label class="weui-form-preview__label">备注</label>
						<span class="weui-form-preview__value"><sapn class="comment"></sapn></span>
					</div>
				</div>
				<div class="weui-form-preview__ft">
					<button type="button" class="weui-form-preview__btn weui-form-preview__btn_primary lookInfo">查看详情</button>
					<button type="button" class="weui-form-preview__btn weui-form-preview__btn_default delete">删除</button>
				</div>
			</div>
		</div>
	</div>
	<div id="" class="weui-popup__container">
		<div class="weui-popup__overlay"></div>
		<div class="weui-popup__modal">
			<div class="popupInfo clone">
				<div class="weui-flex">
					<div class="weui-flex__item">
						需求编号: <span class="needPartCode"></span>
					</div>
				</div>
				<div class="weui-flex">
					<div class="weui-flex__item">
						配件编号: <span class="partsCode"></span>
					</div>
				</div>
				<div class="weui-flex">
					<div class="weui-flex__item">
						配件名称: <span class="partsName"></span>
					</div>
				</div>
				<div class="weui-flex">
					<div class="weui-flex__item">
						品牌: <span class="partsBrand"></span>
					</div>
					<div class="weui-flex__item">
						类别: <span class="partsType"></span>
					</div>
				</div>
				<div class="weui-flex">
					<div class="weui-flex__item">
						数量: <span class="quantity"></span>
					</div>
					<div class="weui-flex__item">
						价格: <span class="price"></span>
					</div>
				</div>
				<div class="weui-flex">
					<div class="weui-flex__item">
						总价: <span class="totalPrice"></span>
					</div>
				</div>
			</div>
		</div>
	</div>


	<!-- <script src="https://cdn.bootcss.com/jquery/1.11.0/jquery.min.js"></script> -->
	<script src="https://cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
	<!-- <script src="https://cdn.bootcss.com/jquery-weui/1.2.0/js/jquery-weui.js"></script> -->
	<script src="../../js/weui/jquery-weui.min.js"></script>
	<!-- <script src="../../js/debuggap.js"></script> -->
	<script>
		$(document).ready(function(){
			$.getJSON('history.json',function(json){
				if(json.success && json.data && json.data.length){
					$.each(json.data,function(){
						var that = this;
						var resultPartClone = $('.container .clone').clone().removeClass('clone').show();
						resultPartClone.find('.time').html(formatTime(this.createdTime));					//时间
						if(this.codes){
							resultPartClone.find('.count').html(this.codes.length);							//品种
							var totalPrice = 0;
							$.each(this.codes,function(){
								if(this.price && this.quantity)
									totalPrice+= parseFloat(this.price) * parseInt(this.quantity);
							});
							resultPartClone.find('.totalPrice').html(totalPrice);							//总金额
						}
						if(this.billExtends && this.billExtends.length){
							$.each(this.billExtends,function(){
								if(this.name == 'COMMENT')
									resultPartClone.find('.comment').html(this.value);						//备注
								else if(this.name == 'WECHAT_CONTENT'){
									resultPartClone.find('.searchedValue').html(this.value);				//查询历史
								}
							});
						}
						if(this.customer)
							resultPartClone.find('.merchantName').html(this.customer.name);
						resultPartClone.find('.delete').click(function(){
							$.confirm('确定删除当前历史?',function(){
								$.ajax({
									url: '/wechat/inquire/history?id=' + that.id,
									type: 'DELETE'
								}).success(function(){
									resultPartClone.remove();
								});
							});
							return false;
						});
						resultPartClone.find('.lookInfo').click(function(){
							$('.weui-popup__container').prop('id', that.id);
							$('#' + that.id).find('.weui-popup__modal').find('.popupInfo').not('.clone').remove();
							$('#' + that.id).find('.weui-popup__modal').find('.searchHistory').remove();
							$('#' + that.id).find('.weui-popup__modal').find('.close-popup').remove();
							//详情内容
							if(that.codes){
								$.each(that.codes,function(){
									var popupInfo = $('#' + that.id).find('.clone').clone().removeClass('clone').show();
									popupInfo.find('.needPartCode').html(this.code);											//需求编号
									if(this.parts){
										popupInfo.find('.partsCode').html(this.parts.code);										//配件编号
										popupInfo.find('.partsName').html(this.parts.name);										//配件名称
										popupInfo.find('.partsBrand').html(this.parts.brand.name);								//配件品牌
										popupInfo.find('.partsType').html(typeKeyToValue(this.parts.tags[1000]));				//配件类别
									}
									popupInfo.find('.quantity').html(this.quantity);											//数量
									popupInfo.find('.price').html(this.price);													//价格
									popupInfo.find('.totalPrice').html(parseInt(this.quantity) * parseFloat(this.price));		//总价
									$('#' + that.id).find('.weui-popup__modal').append(popupInfo);
								});
								var closeBtn = $('<a />').addClass('weui-btn weui-btn_primary close-popup').text('关闭');
								$('#' + that.id).find('.weui-popup__modal').append(closeBtn);
							}
							$('#' + that.id).popup();
						});
						$('.container').append(resultPartClone);
					});
				}else{
					$('.noMoreDataTip').show();
				}


				$('#searchInput').on('input',function(){
					var searchValue = $(this).val();
					$('.container .resultPart').hide();
					$('.container .resultPart').not('.clone').each(function(){
						var value = $.trim($(this).find('.searchedValue').text());
						if(value.indexOf(searchValue) != -1){
							$(this).show();
						}
					});
				});
				$('#searchCancel,#searchClear').click(function(){
					$('.container .resultPart').not('.clone').show();
					console.log('111');
				});
			})
			$('h3').click(function(){
				console.log('23123');
			})
			//时间格式化
			function formatTime(time) {
				var date = new Date(time * 1000);
				var month = date.getMonth() + 1;
				var day = date.getDate();
				var hour = date.getHours();
				var minute = date.getMinutes();
				return month + '-' + formatNum(day) + ' ' + hour + ':' + formatNum(minute);
			}
			//数字格式化
			function formatNum(num){
				if(num < 10)
					num = '0' + num;
				return num;
			}
			function typeKeyToValue(name){
				//PartsType  为 getPartsType.js中的变量（全局）
				for(var key in PartsType){
					if(name == key||name == PartsType[key]){
						return PartsType[key];
					}
				}
			}
			var PartsType = {
				"OE":"主机原厂件",
				"SUPPORTOE":"配套原厂件",
				"CIRCULATEOE":"流通原厂件",
				"AM":"经济适用件",
				"BRANDPARTS":"配套品牌件",
				"AFTERMARKETBRANDPARTS":"售后品牌件",
				"DETACHEDPARTS":"拆车回用件",
				"RENOVATIONPARTS":"再制造件",
				"COMMONPARTS":"通用件",
				"CHOICESTPARTS":"精品选装件",
				"INDUSTRIALPARTS":"工业用品",
				"TOOLEQUIPMENT":"工具设备",
				"OTHERS":"其他"
			}
		});
	</script>
</body>
</html>
