<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<!--<link rel="stylesheet" href="weUI/weui.min.css">-->
	<!-- <link rel="stylesheet" href="https://cdn.bootcss.com/weui/1.1.2/style/weui.min.css"> -->
	<!-- <link rel="stylesheet" href="https://cdn.bootcss.com/jquery-weui/1.2.0/css/jquery-weui.min.css"> -->
	<link rel="stylesheet" href="../js/weui/weui.min.css">
	<link rel="stylesheet" href="../js/weui/jquery-weui.min.css">
	<link rel="stylesheet" href="demo.css">
	<title>询价回复</title>
</head>
<body ontouchstart>
	<div class="paging">
		<!--公共部分-->
		<div data-role="header" id="header">
			<header>
				<h3>询价回复</h3>
			</header>
			<div class="select">
				<div class="merchantStrategy">
					<label>商户策略:</label>
					<div id="merchantPicker"></div>
					<!-- <input type="text" id="merchantPicker" readonly> -->
					<!-- <select name="" id="merchantPicker"></select> -->
				</div>
				<div class="addPart">+</div>
				<div class="deletePart">
					<i class="weui-icon-delete"></i>
				</div>
			</div>
		</div>
		<div class="container">
			<div class="weui-loadmore weui-loadmore_line noMoreDataTip">
				<span class="weui-loadmore__tips">暂无数据</span>
			</div>
			<div class="containerDiv clone">
				<!--页数-->
				<div class="pageInfo">
					<span class="pageNow"></span>/<span class="pageCount"></span>
				</div>
				<!--需求部分-->
				<div class="weui-cell weui-cell_swiped needPartContainer">
					<div class="weui-cell__bd" style="transform: translate3d(0px, 0px, 0px);padding-bottom: 1em;overflow:hidden">
						<div class="previous"></div>
						<div class="needPart">
							<div class="weui-cell__ft" style="width:80%;word-break: break-all">
								需求编号: <span class="needPartsCode">ABC12344</span>
							</div>
							<div class="weui-cell__ft">
								需求数量:
								<div class="weui-count">
									<a class="weui-count__btn weui-count__decrease"></a>
									<input type="number" class="weui-count__number needPartsQuantity" value="1">
									<a class="weui-count__btn weui-count__increase"></a>
								</div>
							</div>

						</div>
						<div class="next"></div>
					</div>

					<div class="weui-cell__ft">
						<a class="weui-swiped-btn weui-swiped-btn_warn delete-swipeout">删除</a>
					</div>
				</div>
				<!--列表部分-->
				<div class="resultPartContainer">
					<div class="resultPart">
						<div class="weui-flex">
							<div class="weui-flex__item">
								供应商: <span class="merchantName"></span>
							</div>
						</div>
						<div class="weui-flex">
							<div class="weui-flex__item">
								商品编号: <span class="productCode"></span>
							</div>
						</div>
						<div class="weui-flex">
							<div class="weui-flex__item">
								配件编号: <span class="partsCode"></span>
							</div>
						</div>
						<div class="weui-flex">
							<div class="weui-flex__item">
								配件名称: <span class="partsName"></span>
							</div>
						</div>
						<div class="weui-flex">
							<div class="weui-flex__item">
								配件类别: <span class="partsType"></span>
							</div>
							<div class="weui-flex__item">
								配件品牌: <span class="partsBrand"></span>
							</div>
						</div>
						<div class="weui-flex">
							<div class="weui-flex__item">
								<div class="weui-cell weui-cell_vcode" style="padding-left:0;">
									<div class="weui-cell__hd">
										<label class="weui-label" style="width:3em">单价: </label>
									</div>
									<div class="weui-cell__bd" style="margin-left: .2em">
										<input class="weui-input" type="number" placeholder="单价">
									</div>
								</div>
							</div>
							<div class="weui-flex__item">
								库存: <span class="partsInventory"></span>
							</div>
						</div>
					</div>

					<div class="weui-loadmore weui-loadmore_line noDataTip">
						<span class="weui-loadmore__tips">暂无数据</span>
					</div>
				</div>
			</div>

		</div>
		<div class="weui-cell weui-cell_vcode inquireComment">
			<div class="weui-cell__bd">
				<input class="weui-input" type="text" placeholder="备注">
			</div>
			<div class="weui-cell__ft">
				<button class="weui-vcode-btn btn-save">下一步</button>
			</div>
		</div>
		<!-- <a href="javascript:;" class="weui-btn weui-btn_default btn-save">保存并预览</a> -->
	</div>
	<div class="weui-loadmore loadingIcon">
		<i class="weui-loading"></i>
		<span class="weui-loadmore__tips">正在加载</span>
	</div>
	<div class="loadingTip"></div>
	<input type="hidden" class="code" value="${id!}">

	<!-- <script src="https://cdn.bootcss.com/jquery/1.11.0/jquery.min.js"></script> -->
	<script src="https://cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
	<!-- <script src="https://cdn.bootcss.com/jquery-weui/1.2.0/js/jquery-weui.js"></script> -->
	<script src="../js/weui/jquery-weui.min.js"></script>
	<script>
		$(document).ready(function(){
			function ismobile(test){
				var u = navigator.userAgent, app = navigator.appVersion;
				if(/AppleWebKit.*Mobile/i.test(navigator.userAgent) || (/MIDP|SymbianOS|NOKIA|SAMSUNG|LG|NEC|TCL|Alcatel|BIRD|DBTEL|Dopod|PHILIPS|HAIER|LENOVO|MOT-|Nokia|SonyEricsson|SIE-|Amoi|ZTE/.test(navigator.userAgent))){
					if(window.location.href.indexOf("?mobile")<0){
						try{
							if(/iPhone|mac|iPod|iPad/i.test(navigator.userAgent)){
								return '0';
							}else{
								return '1';
							}
						}catch(e){}
					}
				}else if( u.indexOf('iPad') > -1){
						return '0';
				}else{
					return '1';
				}
			};
			// if(ismobile() == 1){
			// 	alert('Android')
			// }else{
			// 	alert('iphone');
			// }


			var code = $('.code').val();
			//获取策略商户列表
			$.getJSON('customers.json',function(customers){
				if(customers.success && customers.data && customers.data.length){
					var customersArr = [];
					$.each(customers.data,function(){
						var customersObj = {};
						customersObj['title'] = this.merchant.name;
						customersObj['value'] = this.merchant.id;
						customersArr.push(customersObj);
						// if(this.merchant.id == 999){
							// var option = $('<option />').val(this.merchant.id).text(this.merchant.name);
							// $('#merchantPicker').append(option);
						// }
						if(this.merchant.id == 999)
							$('#merchantPicker').val(this.merchant.name).attr('data-values',this.merchant.id);
					});
					$('#merchantPicker').select({
						title: '请选择策略商户',
						items: customersArr,
						onClose: function (obj) {
							$('#merchantPicker').text(obj.data.titles);
							changeMerchant(obj.data.values);
						}
					});
				}
			});
			//添加配件
			$('.addPart').click(function(){
				$.prompt({
					title: '请输入配件编号',
					// text: '文本',
					// input: '配件编号',
					empty: null,
					onOK: function(value){
						console.log(value);
						if(value.length < 4){

							return false;
						}
						addNewPart(value);
					},
					onCancel: function(){

					}
				});
				// $('#weui-prompt-input').remove();
				var input = $('<input />').addClass('addNewPart').prop('type','text');
				// $(".weui-dialog__bd").append(input);
			});
			//删除配件
			$('.deletePart').click(function(){
				if(!$('.containerDiv').not('.clone').length){
					$.alert("暂无可删除的配件");
					return false;
				}
				$.confirm('确认删除当前需求配件？', function () {
					removePart();
				});
			});
			var GLOBAL = {
				pageNow: 0,
				pageCount: 0,
				jsonData: null
			};
			startLoading();
			function getData(callback,merchantId){
				var id = merchantId || 0;
				$.getJSON('demo.json',function(json){
					if(json.success && callback)
						callback(json);
				});
			}
			//获取当前页数据(根据当前bill)
			function initData(){

			}
			$.getJSON('bill.json',function(billInfo){
				var merchantId = billInfo.data[0].customer ? billInfo.data[0].customer.id : 0;
				var hasCustomer = false;
				if(billInfo.data[0].customer && billInfo.data[0].codes.length)
					hasCustomer = true;
				getData(function(json){
					removeLoading();
					if(json.success && json.data && json.data.length){
						var productsObj = {};
						$.each(json.data,function(j){
							if(!productsObj[this.product.originCode.code]){
								productsObj[this.product.originCode.code] = [this];
							}
							else{
								productsObj[this.product.originCode.code].push(this);
							}
						});
						var productSelected = {};
						//存在当前报价单
						if(hasCustomer){
							// $.getJSON('/data/merchant/' + billInfo.data[0].customer.id,function(merchantInfo){
								// $('#merchantPicker').val(merchantInfo.name).attr('data-values',billInfo.data[0].customer.id);
								// $('#merchantPicker').val('测试商户A').attr('data-values',billInfo.data[0].customer.id);
								$('#merchantPicker').text('测试商户A').attr('data-values',billInfo.data[0].customer.id);
								// $('#merchantPicker').val(billInfo.data[0].customer.id);
							// });
							$.each(billInfo.data[0].codes,function(codeInfo){
								var isHasSelected = false;
								//当前商品无供应
								if(!this.selected){
									selecteProduct(code ,this.id, 0);
									return true;
								}
								//商品有供应
								else{
									var that = this;
									$.each(productsObj,function(key){
										if(key == that.code){
											productsObj[key].sort(function(a, b){
												return parseInt(a.price) - parseInt(b.price);
											});
											productsObj[key].sort(function(a, b){
												if(!a.priority && b.priority)
													return 1;
												else if(a.priority && !b.priority)
													return -1;
												else
													return parseInt(b.priority) - parseInt(a.priority);
											});
											$.each(productsObj[key],function(count){
												if(that.selected == this.id){
													isHasSelected = true;
													productSelected[key] = this.id;
													this.price = that.price;
													return false;
												}else if(count == productsObj[key].length - 1){
													selecteProduct(code ,productsObj[key][0].product.originCode.id, productsObj[key][0].id);
													productSelected[key] = productsObj[key][0].id;
												}
											});
											if(isHasSelected)
												return false;
										}
									});
								}
							});
						}
						$.each(productsObj,function(key,value){
							var containerDivClone = $('.clone').clone().removeClass('clone').addClass('containerDiv' + GLOBAL.pageCount);
							containerDivClone.find('.pageNow').html(GLOBAL.pageCount + 1);
							containerDivClone.find('.pageCount').html(Object.getOwnPropertyNames(productsObj).length);
							if(GLOBAL.pageCount != 0)
								containerDivClone.hide();
							containerDivClone.find('.needPartsCode').html(key);
							containerDivClone.find('.needPartsCode').attr('originId',value[0].product.originCode.id);
							if(!hasCustomer)
								productsObj[key].sort(function(a, b){
									return parseInt(a.price) - parseInt(b.price);
								});
							if(productsObj[key].length == 1 && !productsObj[key][0].id){
								containerDivClone.find('.resultPart').hide();
								containerDivClone.find('.noDataTip').show();
								$('.container').append(containerDivClone);
								GLOBAL.pageCount++;
								return true;
							}
							$.each(productsObj[key],function(){
								var resultPartClone = containerDivClone.find('.resultPart').eq(0).clone();
								resultPartClone.attr('productId',this.id);
								resultPartClone.find('.merchantName').html(this.supplier.name);
								resultPartClone.find('.productCode').html(this.product.code);
								resultPartClone.find('.partsCode').html(formatPartsCode(this.product.parts.code));
								resultPartClone.find('.partsName').html(this.product.parts.name);
								resultPartClone.find('.partsType').html(typeKeyToValue(this.product.parts.tags[1000]));
								resultPartClone.find('.partsType').attr('tags',(this.product.parts.tags[1000]));
								resultPartClone.find('.partsBrand').html(this.product.parts.brand.name);
								resultPartClone.find('.partsBrand').attr('brandId',this.product.parts.brand.id);
								resultPartClone.find('.partsInventory').html(this.product.inventory);
								resultPartClone.find('.weui-input').val(this.price);
								containerDivClone.find('.resultPartContainer').append(resultPartClone);
								if(this.id == productSelected[key])
									resultPartClone.addClass('selected');
							});
							containerDivClone.find('.resultPartContainer').find('.resultPart').eq(0).remove();
							if(!productSelected[key])
								containerDivClone.find('.resultPartContainer').find('.resultPart').eq(0).addClass('selected');
							$('.container').append(containerDivClone);
							GLOBAL.pageCount++;
						});
					}else{
						$('.noMoreDataTip').show();
					}
					action();
				},merchantId);
			});
			//商品selected请求
			function selecteProduct(id , codeId, select){
				if (id === '' || !codeId)
					return;
				var data = {
					codeId: codeId,
					id: id,
					select: select
				}
				$.ajax({
					url: '/wechat/reply/select',
					method: 'PUT',
					data: data
				});
			}
			//商户选择
			function changeMerchant(value){
				startLoading();
				getData(function(json){
					removeLoading();
					if(json.success && json.data && json.data.length){
						$('.containerDiv').not('.clone').remove();
						GLOBAL.pageCount = 0;

						var productsObj = {};
						$.each(json.data,function(j){
							if(!productsObj[this.product.originCode.code]){
								productsObj[this.product.originCode.code] = [this];
							}
							else{
								productsObj[this.product.originCode.code].push(this);
							}
						});

						$.each(productsObj,function(key,value){
							var containerDivClone = $('.clone').clone().removeClass('clone').addClass('containerDiv' + GLOBAL.pageCount);
							containerDivClone.find('.pageNow').html(GLOBAL.pageCount + 1);
							containerDivClone.find('.pageCount').html(Object.getOwnPropertyNames(productsObj).length);
							if(GLOBAL.pageCount != 0)
								containerDivClone.hide();
							containerDivClone.find('.needPartsCode').html(key);
							containerDivClone.find('.needPartsCode').attr('originId',value[0].product.originCode.id);
							productsObj[key].sort(function(a, b){
								return parseInt(a.price) - parseInt(b.price);
							});
							if(productsObj[key].length == 1 && !productsObj[key][0].id){
								containerDivClone.find('.resultPart').hide();
								containerDivClone.find('.noDataTip').show();
								$('.container').append(containerDivClone);
								GLOBAL.pageCount++;
								return true;
							}
							$.each(productsObj[key],function(){
								var resultPartClone = containerDivClone.find('.resultPart').eq(0).clone();
								resultPartClone.attr('productId',this.id);
								resultPartClone.find('.merchantName').html(this.supplier.name);
								resultPartClone.find('.productCode').html(this.product.code);
								resultPartClone.find('.partsCode').html(formatPartsCode(this.product.parts.code));
								resultPartClone.find('.partsName').html(this.product.parts.name);
								resultPartClone.find('.partsType').html(typeKeyToValue(this.product.parts.tags[1000]));
								resultPartClone.find('.partsType').attr('tags',(this.product.parts.tags[1000]));
								resultPartClone.find('.partsBrand').html(this.product.parts.brand.name);
								resultPartClone.find('.partsBrand').attr('brandId',this.product.parts.brand.id);
								resultPartClone.find('.partsInventory').html(this.product.inventory);
								resultPartClone.find('.weui-input').val(this.price);
								containerDivClone.find('.resultPartContainer').append(resultPartClone);
							});
							containerDivClone.find('.resultPartContainer').find('.resultPart').eq(0).remove();
							containerDivClone.find('.resultPartContainer').find('.resultPart').eq(0).addClass('selected');
							$('.container').append(containerDivClone);
							GLOBAL.pageCount++;
						});
					}
					refreshData();
					action();
				},value);
			}
			//添加一个配件
			function addNewPart(partCode){
				$.getJSON('noData.json', function (json) {
					if(json.success && json.data && json.data.length){
						GLOBAL.pageCount++;
						var containerDivClone = $('.clone').clone().removeClass('clone').addClass('containerDiv' + (GLOBAL.pageCount-1));
						containerDivClone.find('.pageNow').html(GLOBAL.pageCount);
						containerDivClone.find('.pageCount').html(GLOBAL.pageCount);
						$('.pageCount').html(GLOBAL.pageCount);
						containerDivClone.find('.needPartsCode').html(json.data[0].product.originCode.code);
						json.data.sort(function(a, b){
							return parseInt(a.price) - parseInt(b.price);
						});
						if(json.data.length == 1 && !json.data[0].id){
							containerDivClone.find('.resultPart').hide();
							containerDivClone.find('.noDataTip').show();
							$('.container').append(containerDivClone);
							GLOBAL.pageNow = GLOBAL.pageCount - 1;
						}else{
							$.each(json.data,function(){
								var resultPartClone = containerDivClone.find('.resultPart').eq(0).clone();
								resultPartClone.find('.merchantName').html(this.supplier.name);
								resultPartClone.find('.productCode').html(this.product.code);
								resultPartClone.find('.partsCode').html(formatPartsCode(this.product.parts.code));
								resultPartClone.find('.partsName').html(this.product.parts.name);
								resultPartClone.find('.partsType').html(typeKeyToValue(this.product.parts.tags[1000]));
								resultPartClone.find('.partsBrand').html(this.product.parts.brand.name);
								resultPartClone.find('.partsInventory').html(this.product.inventory);
								resultPartClone.find('.weui-input').val(this.price);
								containerDivClone.find('.resultPartContainer').append(resultPartClone);
							});
							containerDivClone.find('.resultPartContainer').find('.resultPart').eq(0).remove();
							containerDivClone.find('.resultPartContainer').find('.resultPart').eq(0).addClass('selected');
							$('.container').append(containerDivClone);
							GLOBAL.pageNow = GLOBAL.pageCount - 1;
						}
					}
					refreshData();
					action();
				});


				// var params = {};
				// var customerId = $('#merchantPicker').attr('data-values');
				// params['id'] = code;
				// params['customer'] = customerId;
				// params['code'] = partCode;
				// console.log(params);
				// return false;
				// $.ajax({
				// 	url: '/wechat/reply/code',
				// 	method: 'POST',
				// 	data: params
				// }).success(function(json){
				// 	if(json.success && json.data && json.data.length){
				// 		GLOBAL.pageCount++;
				// 		var containerDivClone = $('.clone').clone().removeClass('clone').addClass('containerDiv' + (GLOBAL.pageCount-1));
				// 		containerDivClone.find('.pageNow').html(GLOBAL.pageCount);
				// 		containerDivClone.find('.pageCount').html(GLOBAL.pageCount);
				// 		$('.pageCount').html(GLOBAL.pageCount);
				// 		containerDivClone.find('.needPartsCode').html(json.data[0].product.originCode.code);
				// 		json.data.sort(function(a, b){
				// 			return parseInt(a.price) - parseInt(b.price);
				// 		});
				// 		if(json.data.length == 1 && !json.data[0].id){
				// 			containerDivClone.find('.resultPart').hide();
				// 			containerDivClone.find('.noDataTip').show();
				// 			$('.container').append(containerDivClone);
				// 			GLOBAL.pageNow = GLOBAL.pageCount - 1;
				// 		}else{
				// 			$.each(json.data,function(){
				// 				var resultPartClone = containerDivClone.find('.resultPart').eq(0).clone();
				// 				resultPartClone.find('.merchantName').html(this.supplier.name);
				// 				resultPartClone.find('.productCode').html(this.product.code);
				// 				resultPartClone.find('.partsCode').html(this.product.parts.code);
				// 				resultPartClone.find('.partsName').html(this.product.parts.name);
				// 				resultPartClone.find('.partsType').html(typeKeyToValue(this.product.parts.tags[1000]));
				// 				resultPartClone.find('.partsBrand').html(this.product.parts.brand.name);
				// 				resultPartClone.find('.partsInventory').html(this.product.inventory);
				// 				resultPartClone.find('.weui-input').val(this.price);
				// 				containerDivClone.find('.resultPartContainer').append(resultPartClone);
				// 			});
				// 			containerDivClone.find('.resultPartContainer').find('.resultPart').eq(0).remove();
				// 			containerDivClone.find('.resultPartContainer').find('.resultPart').eq(0).addClass('selected');
				// 			$('.container').append(containerDivClone);
				// 			GLOBAL.pageNow = GLOBAL.pageCount - 1;
				// 		}
				// 	}
				// 	refreshData();
				// 	action();
				// });
			}
			//删除一个配件
			function removePart(){
				$.getJSON('deleted.json',function(json){
					if(json.success){
						$('.containerDiv' + GLOBAL.pageNow).remove();
						GLOBAL.pageCount--;
						GLOBAL.pageNow--;
						$('.containerDiv').not('.clone').each(function(k){
							$(this).removeClass('containerDiv' + (k + 1)).addClass('containerDiv' + k);
							$(this).find('.pageInfo .pageNow').html(k + 1);
							$(this).find('.pageInfo .pageCount').html(GLOBAL.pageCount);
						});
						if(GLOBAL.pageNow == -1)
							GLOBAL.pageNow = 0;
						refreshData();
					}
				});



				// var originId = $('.containerDiv' + GLOBAL.pageNow).find('.needPartsCode').attr('originId');
				// console.log(originId);
				// return false;
				// $.ajax({
				// 	url: '/wechat/reply/code?id=' + originId,
				// 	method: 'DELETE',
				// }).success(function(json){
				// 	if(json.success){
				// 		$('.containerDiv' + GLOBAL.pageNow).remove();
				// 		GLOBAL.pageCount--;
				// 		GLOBAL.pageNow--;
				// 		$('.containerDiv').not('.clone').each(function(k){
				// 			$(this).removeClass('containerDiv' + (k + 1)).addClass('containerDiv' + k);
				// 			$(this).find('.pageInfo .pageNow').html(k + 1);
				// 			$(this).find('.pageInfo .pageCount').html(GLOBAL.pageCount);
				// 		});
				// 		if(GLOBAL.pageNow == -1)
				// 			GLOBAL.pageNow = 0;
				// 		refreshData();
				// 	}
				// });
			}
			//刷新数据
			function refreshData(){
				if(!$('.containerDiv' + GLOBAL.pageNow).length)
					$('.noMoreDataTip').show();
				else
					$('.noMoreDataTip').hide();
				$('.containerDiv').hide();
				$('.containerDiv' + GLOBAL.pageNow).show();
			}
			//动作
			function action(){
				$('.previous').unbind().click(function(){
					GLOBAL.pageNow--;
					if(GLOBAL.pageNow < 0)
						GLOBAL.pageNow = GLOBAL.pageCount - 1;
					$('.containerDiv').hide();
					$('.containerDiv' + GLOBAL.pageNow).show();
				});
				$('.next').unbind().click(function(){
					GLOBAL.pageNow++;
					if(GLOBAL.pageNow > (GLOBAL.pageCount -1))
						GLOBAL.pageNow = 0;
					$('.containerDiv').hide();
					$('.containerDiv' + GLOBAL.pageNow).show();
				});
				$('.weui-cell_swiped').swipeout();
				//选择配件
				$('.resultPart').unbind().click(function(){
					var that = $('.containerDiv' + GLOBAL.pageNow).find('.resultPart');
					if($(this).hasClass('selected'))
						return false;
					that.removeClass('selected');
					$(this).addClass('selected');
				});
				//更改价格时阻止选择配件
				$('.weui-flex__item .weui-cell').unbind().click(function(){
					return false;
				});

				//需求数量js
				var MAX = Infinity, MIN = 1;
				$('.weui-count__decrease').unbind().click(function (e) {
					var $input = $(e.currentTarget).parent().find('.weui-count__number');
					var number = parseInt($input.val() || "0") - 1
					if (number < MIN) number = MIN;
					$input.val(number);
				});
				$('.weui-count__increase').unbind().click(function (e) {
					var $input = $(e.currentTarget).parent().find('.weui-count__number');
					var number = parseInt($input.val() || "0") + 1
					if (number > MAX) number = MAX;
					$input.val(number);
				});
				$('.weui-cell_swiped').on('swipeout-open',function(){
					$('.previous,.next').hide();
				});
				$('.weui-cell_swiped').on('swipeout-close',function(){
					$('.previous,.next').show();
				});
				$('.delete-swipeout').unbind().click(function(){
					$.confirm('确认删除当前需求配件？', function () {
						removePart();
						$('.weui-cell_swiped').swipeout('close');
					});
				});

				//
				$('.resultPart .weui-input').focus(function(){
					$('.resultPartContainer').css('paddingBottom','30vh');
				});
				$('.resultPart .weui-input').blur(function(){
					$('.resultPartContainer').css('paddingBottom','0');
				});
			}

			$('.btn-save').click(saveParams);
			//提交数据
			function saveParams(){
				var params = {};
				var code = $('.code').val();
				var customerId = $('#merchantPicker').attr('data-values');
				var comment = $('.inquireComment .weui-input').val();
				if($.trim(comment)){
					params['billExtends[0].billTags'] = "WECHAT_CONTENT";
					params['billExtends[0].value'] = comment;
				}
				params['customer.id'] = customerId;
				params['originId'] = code;
				var needParts = $('.containerDiv').not('.clone');
				var paramsNum = 0;
				$.each(needParts,function(k){
					var that = $(this);
					if(!that.find('.selected').attr('productId'))
						return true;
					// params['codes['+paramsNum+'].code'] = that.find('.selected .partsCode').html();
					// params['codes['+paramsNum+'].name'] = that.find('.selected .partsName').html();
					// params['codes['+paramsNum+'].price'] = that.find('.selected .weui-input').val();
					// params['codes['+paramsNum+'].quantity'] = that.find('.needPart .weui-count__number').val();
					// params['codes['+paramsNum+'].type'] = that.find('.selected .partsType').attr('tags');
					// params['codes['+paramsNum+'].brand.id'] = that.find('.selected .partsBrand').attr('brandId');
					// params['codes['+paramsNum+'].originId'] = that.find('.needPartsCode').attr('originId');
					// params['codes['+paramsNum+'].selected'] = that.find('.selected').attr('productId');

					params['codes['+paramsNum+'].code'] = that.find('.needPartsCode').html();					//需求编号
					params['codes['+paramsNum+'].price'] = that.find('.selected .weui-input').val();			//价格
					params['codes['+paramsNum+'].quantity'] = that.find('.needPart .weui-count__number').val();	//需求数量
					params['codes['+paramsNum+'].selected'] = that.find('.selected').attr('productId');			//supplyingId

					paramsNum++;
				});
				if(needParts.length == 0){
					$.alert('暂无可保存商品');
					return false;
				}else if(needParts.length != paramsNum){
					$.alert('请确认商品有供应');
					return false;
				}
				console.log(params);
				var billId = '1321';
				// location.href = 'info/info.html?id=' + encode64(billId);
				return false;
				$.ajax({
					url: '/wechat/inquire/save',
					method: 'POST',
					data: params
				}).success(function(json){
					if(json.success && json.data && json.data.length){
						var billId = json.data[0].id;
						location.href = '/wechat/inquire/replyInfo?id='+billId;
					}
				});
			}

			function typeKeyToValue(name){
				//PartsType  为 getPartsType.js中的变量（全局）
				for(var key in PartsType){
					if(name == key||name == PartsType[key]){
						return PartsType[key];
					}
				}
			}
			var PartsType = {
				"OE":"主机原厂件",
				"SUPPORTOE":"配套原厂件",
				"CIRCULATEOE":"流通原厂件",
				"AM":"经济适用件",
				"BRANDPARTS":"配套品牌件",
				"AFTERMARKETBRANDPARTS":"售后品牌件",
				"DETACHEDPARTS":"拆车回用件",
				"RENOVATIONPARTS":"再制造件",
				"COMMONPARTS":"通用件",
				"CHOICESTPARTS":"精品选装件",
				"INDUSTRIALPARTS":"工业用品",
				"TOOLEQUIPMENT":"工具设备",
				"OTHERS":"其他"
			}
			function startLoading(){
				$('.loadingTip,.loadingIcon').show();
			}
			function removeLoading(){
				$('.loadingTip,.loadingIcon').hide();
			}
			var keyStr = "ABCDEFGHIJKLMNOP" +"QRSTUVWXYZabcdef" +"ghijklmnopqrstuv" +"wxyz0123456789+/" + "=";
			function encode64(input) {
				var output = "";
				var chr1, chr2, chr3 = "";
				var enc1, enc2, enc3, enc4 = "";
				var i = 0;
				do{
					chr1 = input.charCodeAt(i++);
					chr2 = input.charCodeAt(i++);
					chr3 = input.charCodeAt(i++);
					enc1 = chr1 >> 2;
					enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);
					enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);
					enc4 = chr3 & 63;
					if (isNaN(chr2)){
						enc3 = enc4 = 64;
					}else if (isNaN(chr3)){
						enc4 = 64;
					}
					output = output +
					keyStr.charAt(enc1) +
					keyStr.charAt(enc2) +
					keyStr.charAt(enc3) +
					keyStr.charAt(enc4);
					chr1 = chr2 = chr3 = "";
					enc1 = enc2 = enc3 = enc4 = "";
				} while (i < input.length);
				return output;
			}

			function formatPartsCode(code){
				var partsCode = code.replace(/\~.+$/g, '');
				return partsCode;
			}
		});
	</script>
</body>
</html>
